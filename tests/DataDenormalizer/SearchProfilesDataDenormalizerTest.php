<?php

declare(strict_types=1);

namespace Doctolib\Test\DataDenormalizer;

use Doctolib\DataDenormalizer\SearchProfilesDataDenormalizer;
use PHPUnit\Framework\TestCase;

/**
 * @internal
 * @covers \Doctolib\DataDenormalizer\SearchProfilesDataDenormalizer
 */
class SearchProfilesDataDenormalizerTest extends TestCase
{
    public function testDenormalize(): void
    {
        $jsonData = <<<'JSON'
{"data":{"speciality":{"id":4,"name":"Ophtalmologue","slug":"ophtalmologue","search_results_priority":false,"telehealth_core":false,"vaccination":false,"covid_vaccination_hcp_speciality":false},"doctors":[{"id":1406598,"is_directory":false,"address":"47 Rue des Mathurins","city":"Paris","zipcode":"75008","link":"/centre-de-sante/paris/centre-acces-vision","cloudinary_public_id":"coyfqqthltw7g9pthuft","profile_id":97958,"exact_match":true,"priority_speciality":false,"first_name":null,"last_name":"Centres Accès Vision","name_with_title":"Centres Accès Vision","speciality":null,"organization_status":"Centre de santé","top_specialities":["2 ophtalmologues"],"position":{"lat":48.8732993,"lng":2.32298519999995},"place_id":"practice-115431","telehealth":false},{"id":1473925,"is_directory":false,"address":"90 Rue Saint-Lazare","city":"Paris","zipcode":"75009","link":"/ophtalmologue/paris/john-seed","cloudinary_public_id":"wgpxcgahto4uosccx6xu","profile_id":58877,"exact_match":null,"priority_speciality":false,"first_name":"John","last_name":"SEED","name_with_title":"Dr John SEED","speciality":"Ophtalmologue","organization_status":null,"position":{"lat":48.8759179,"lng":2.32835920000002},"place_id":null,"telehealth":false},{"id":1015059,"is_directory":false,"address":"90 Rue Saint-Lazare","city":"Paris","zipcode":"75009","link":"/ophtalmologue/paris/lea-acasa","cloudinary_public_id":"fa6by5jacyuspztkmanr","profile_id":116434,"exact_match":null,"priority_speciality":false,"first_name":"LEA","last_name":"ACASA","name_with_title":"Dr Lea ACASA","speciality":"Ophtalmologue","organization_status":null,"position":{"lat":48.8759465,"lng":2.32829670000001},"place_id":null,"telehealth":false},{"id":1129717,"is_directory":false,"address":"11 Boulevard de la Madeleine","city":"Paris","zipcode":"75001","link":"/cabinet-medical/paris/point-vision-madeleine-paris","cloudinary_public_id":"c1zf1xyjokcpahsny3ha","profile_id":72886,"exact_match":null,"priority_speciality":false,"first_name":null,"last_name":"Point Vision Paris Madeleine","name_with_title":"Point Vision Paris Madeleine","speciality":null,"organization_status":"Cabinet médical","position":{"lat":48.8694029,"lng":2.32627550000007},"place_id":null,"telehealth":false},{"id":1392173,"is_directory":false,"address":"59 Boulevard Malesherbes","city":"Paris","zipcode":"75008","link":"/ophtalmologue/paris/marie-narbo","cloudinary_public_id":"zj3wwumxrtsxki4wojee","profile_id":3247,"exact_match":null,"priority_speciality":false,"first_name":"Marie","last_name":"NARBO","name_with_title":"Dr Marie NARBO","speciality":"Ophtalmologue","organization_status":null,"position":{"lat":48.8761941,"lng":2.31777039999997},"place_id":null,"telehealth":false},{"id":1303728,"is_directory":false,"address":"4 Rue de Penthièvre","city":"Paris","zipcode":"75008","link":"/ophtalmologue/paris/yassi-boneval","cloudinary_public_id":"rdmlvwxe2pbb5lspc53w","profile_id":17093,"exact_match":null,"priority_speciality":false,"first_name":"Yassi","last_name":"Boneval","name_with_title":"Dr Yassi Boneval","speciality":"Ophtalmologue","organization_status":null,"position":{"lat":48.8734852,"lng":2.31764329999999},"place_id":null,"telehealth":false},{"id":1440980,"is_directory":false,"address":"4 Rue de Penthièvre","city":"Paris","zipcode":"75008","link":"/ophtalmologue/paris/pierre-soula","cloudinary_public_id":"uwb4ncmingqtixdh8der","profile_id":142987,"exact_match":null,"priority_speciality":false,"first_name":"PIERRE","last_name":"SOULA","name_with_title":"Dr Pierre SOULA","speciality":"Ophtalmologue","organization_status":null,"position":{"lat":48.8734852,"lng":2.31764329999999},"place_id":null,"telehealth":true},{"id":1450091,"is_directory":false,"address":"31 Rue de Caumartin","city":"Paris","zipcode":"75009","link":"/centre-medical-et-dentaire/paris/centre-medical-et-dentaire-opera","cloudinary_public_id":"qiusrypdpuh8rghic7yf","profile_id":56698,"exact_match":null,"priority_speciality":false,"first_name":null,"last_name":"Centre Médical et Dentaire Opéra  ","name_with_title":"Centre Médical et Dentaire Opéra","speciality":null,"organization_status":"Centre médical et dentaire","top_specialities":["1 ophtalmologue"],"position":{"lat":48.8719955,"lng":2.32813490000001},"place_id":null,"telehealth":true},{"id":835667,"is_directory":false,"address":"33 Rue de la Chaussée d'Antin","city":"Paris","zipcode":"75009","link":"/centre-de-sante/paris/dentylis-centre-dentaire-et-ophtalmologie-chaussee-d-antin","cloudinary_public_id":"yldvomboftwejlx9n2fl","profile_id":265763,"exact_match":null,"priority_speciality":false,"first_name":null,"last_name":"Dentylis - Centre Dentaire et Ophtalmologie Chaussée d'Antin","name_with_title":"Dentylis - Centre Dentaire et Ophtalmologie Chaussée d'Antin","speciality":null,"organization_status":"Centre de santé","top_specialities":["1 ophtalmologue"],"position":{"lat":48.8745561,"lng":2.3325198},"place_id":null,"telehealth":false},{"id":1454653,"is_directory":false,"address":"25 Rue La Boétie","city":"Paris","zipcode":"75008","link":"/ophtalmologue/paris/jean-cocci-paris","cloudinary_public_id":"fpmpvl1otrjxwklofz52","profile_id":57312,"exact_match":null,"priority_speciality":false,"first_name":"Jean","last_name":"COCCI","name_with_title":"Dr Jean COCCI","speciality":"Ophtalmologue","organization_status":null,"position":{"lat":48.8737525,"lng":2.31608440000002},"place_id":null,"telehealth":false}],"directory_doctors":[],"search_filters_context":[{"label":"Disponibilités","param_name":"availabilities","items":[{"name":"Aujourd'hui","id":1},{"name":"Dans les trois prochains jours","id":3}],"value":null},{"label":"Honoraires","param_name":"regulation_sector","items":[{"name":"Sans dépassements d'honoraires","id":"without_extra"},{"name":"Dépassements d'honoraires modérés","id":"with_extra"}],"value":null},{"label":"Motif de consultation","param_name":"ref_visit_motive_id","items":[{"name":"Première consultation d'ophtalmologie","id":268},{"name":"Consultation d'ophtalmologie","id":716},{"name":"Urgence","id":166},{"name":"Bilan de la vue","id":271}],"value":null},{"label":"Langues parlées","param_name":"language","items":[{"name":"Allemand","id":5},{"name":"Anglais","id":2},{"name":"Arabe","id":9},{"name":"Espagnol","id":3},{"name":"Italien","id":4},{"name":"Langue des signes","id":74},{"name":"Polonais","id":15},{"name":"Portugais","id":6},{"name":"Roumain","id":14},{"name":"Russe","id":16},{"name":"Turc","id":29}],"value":null}],"place":{"id":566509,"name":"Boulevard Haussmann","slug":"paris-boulevard-haussmann-9ccb02fd-270c-41a7-84f2-426ec71d305f","place_id":"Eig3NTAxMSBCb3VsZXZhcmQgSGF1c3NtYW5uLCBQYXJpcywgRnJhbmNlIi4qLAoUChIJeY1zJctv5kcRmQRo7bqo_9wSFAoSCQ-34gYfbuZHEWCUjGjDggsE","position":{"lat":48.87397,"lng":2.32312}},"telehealth_new_patient":false,"directory_title":"D'autres ophtalmologues consultent autour de vous","doctor_title":"Trouvez autour de vous un ophtalmologue (ou un professionnel pratiquant des actes de ophtalmologie) proposant la prise de rendez-vous en ligne","secondary_doctor_title":"D'autres ophtalmologues (ou professionnels pratiquant des actes de ophtalmologie) proposent la prise de rendez-vous en ligne dans les environs de Boulevard Haussmann","prior_nearby_location_title":"D'autres ophtalmologues proposent la prise de rendez-vous en ligne dans les environs de Boulevard Haussmann","non_prior_at_location_title":"D'autres professionnels pratiquant des actes de ophtalmologie proposent la prise de rendez-vous en ligne autour de vous","non_prior_nearby_location_title":"D'autres professionnels pratiquant des actes de ophtalmologie proposent la prise de rendez-vous en ligne dans les environs de Boulevard Haussmann","has_more":true,"search_scope":"speciality","is_hub":false,"total_search_results":999}}
JSON;

        $jsonExpected = <<<'JSON'
{"data":{"speciality":{"id":4,"name":"Ophtalmologue","slug":"ophtalmologue","search_results_priority":false,"telehealth_core":false,"vaccination":false,"covid_vaccination_hcp_speciality":false},"doctors":[{"id":1406598,"is_directory":false,"address":"47 Rue des Mathurins","city":"Paris","zipcode":"75008","link":"\/centre-de-sante\/paris\/centre-acces-vision","cloudinary_public_id":"coyfqqthltw7g9pthuft","profile_id":97958,"exact_match":true,"priority_speciality":false,"first_name":null,"last_name":"Centres Acc\u00e8s Vision","name_with_title":"Centres Acc\u00e8s Vision","speciality":null,"organization_status":"Centre de sant\u00e9","top_specialities":["2 ophtalmologues"],"position":{"lat":48.8732993,"lng":2.32298519999995},"place_id":"practice-115431","telehealth":false},{"id":1473925,"is_directory":false,"address":"90 Rue Saint-Lazare","city":"Paris","zipcode":"75009","link":"\/ophtalmologue\/paris\/john-seed","cloudinary_public_id":"wgpxcgahto4uosccx6xu","profile_id":58877,"exact_match":null,"priority_speciality":false,"first_name":"John","last_name":"SEED","name_with_title":"Dr John SEED","speciality":{"id":4,"name":"Ophtalmologue","slug":"ophtalmologue","search_results_priority":false,"telehealth_core":false,"vaccination":false,"covid_vaccination_hcp_speciality":false},"organization_status":null,"position":{"lat":48.8759179,"lng":2.32835920000002},"place_id":null,"telehealth":false},{"id":1015059,"is_directory":false,"address":"90 Rue Saint-Lazare","city":"Paris","zipcode":"75009","link":"\/ophtalmologue\/paris\/lea-acasa","cloudinary_public_id":"fa6by5jacyuspztkmanr","profile_id":116434,"exact_match":null,"priority_speciality":false,"first_name":"LEA","last_name":"ACASA","name_with_title":"Dr Lea ACASA","speciality":{"id":4,"name":"Ophtalmologue","slug":"ophtalmologue","search_results_priority":false,"telehealth_core":false,"vaccination":false,"covid_vaccination_hcp_speciality":false},"organization_status":null,"position":{"lat":48.8759465,"lng":2.32829670000001},"place_id":null,"telehealth":false},{"id":1129717,"is_directory":false,"address":"11 Boulevard de la Madeleine","city":"Paris","zipcode":"75001","link":"\/cabinet-medical\/paris\/point-vision-madeleine-paris","cloudinary_public_id":"c1zf1xyjokcpahsny3ha","profile_id":72886,"exact_match":null,"priority_speciality":false,"first_name":null,"last_name":"Point Vision Paris Madeleine","name_with_title":"Point Vision Paris Madeleine","speciality":null,"organization_status":"Cabinet m\u00e9dical","position":{"lat":48.8694029,"lng":2.32627550000007},"place_id":null,"telehealth":false},{"id":1392173,"is_directory":false,"address":"59 Boulevard Malesherbes","city":"Paris","zipcode":"75008","link":"\/ophtalmologue\/paris\/marie-narbo","cloudinary_public_id":"zj3wwumxrtsxki4wojee","profile_id":3247,"exact_match":null,"priority_speciality":false,"first_name":"Marie","last_name":"NARBO","name_with_title":"Dr Marie NARBO","speciality":{"id":4,"name":"Ophtalmologue","slug":"ophtalmologue","search_results_priority":false,"telehealth_core":false,"vaccination":false,"covid_vaccination_hcp_speciality":false},"organization_status":null,"position":{"lat":48.8761941,"lng":2.31777039999997},"place_id":null,"telehealth":false},{"id":1303728,"is_directory":false,"address":"4 Rue de Penthi\u00e8vre","city":"Paris","zipcode":"75008","link":"\/ophtalmologue\/paris\/yassi-boneval","cloudinary_public_id":"rdmlvwxe2pbb5lspc53w","profile_id":17093,"exact_match":null,"priority_speciality":false,"first_name":"Yassi","last_name":"Boneval","name_with_title":"Dr Yassi Boneval","speciality":{"id":4,"name":"Ophtalmologue","slug":"ophtalmologue","search_results_priority":false,"telehealth_core":false,"vaccination":false,"covid_vaccination_hcp_speciality":false},"organization_status":null,"position":{"lat":48.8734852,"lng":2.31764329999999},"place_id":null,"telehealth":false},{"id":1440980,"is_directory":false,"address":"4 Rue de Penthi\u00e8vre","city":"Paris","zipcode":"75008","link":"\/ophtalmologue\/paris\/pierre-soula","cloudinary_public_id":"uwb4ncmingqtixdh8der","profile_id":142987,"exact_match":null,"priority_speciality":false,"first_name":"PIERRE","last_name":"SOULA","name_with_title":"Dr Pierre SOULA","speciality":{"id":4,"name":"Ophtalmologue","slug":"ophtalmologue","search_results_priority":false,"telehealth_core":false,"vaccination":false,"covid_vaccination_hcp_speciality":false},"organization_status":null,"position":{"lat":48.8734852,"lng":2.31764329999999},"place_id":null,"telehealth":true},{"id":1450091,"is_directory":false,"address":"31 Rue de Caumartin","city":"Paris","zipcode":"75009","link":"\/centre-medical-et-dentaire\/paris\/centre-medical-et-dentaire-opera","cloudinary_public_id":"qiusrypdpuh8rghic7yf","profile_id":56698,"exact_match":null,"priority_speciality":false,"first_name":null,"last_name":"Centre M\u00e9dical et Dentaire Op\u00e9ra  ","name_with_title":"Centre M\u00e9dical et Dentaire Op\u00e9ra","speciality":null,"organization_status":"Centre m\u00e9dical et dentaire","top_specialities":["1 ophtalmologue"],"position":{"lat":48.8719955,"lng":2.32813490000001},"place_id":null,"telehealth":true},{"id":835667,"is_directory":false,"address":"33 Rue de la Chauss\u00e9e d'Antin","city":"Paris","zipcode":"75009","link":"\/centre-de-sante\/paris\/dentylis-centre-dentaire-et-ophtalmologie-chaussee-d-antin","cloudinary_public_id":"yldvomboftwejlx9n2fl","profile_id":265763,"exact_match":null,"priority_speciality":false,"first_name":null,"last_name":"Dentylis - Centre Dentaire et Ophtalmologie Chauss\u00e9e d'Antin","name_with_title":"Dentylis - Centre Dentaire et Ophtalmologie Chauss\u00e9e d'Antin","speciality":null,"organization_status":"Centre de sant\u00e9","top_specialities":["1 ophtalmologue"],"position":{"lat":48.8745561,"lng":2.3325198},"place_id":null,"telehealth":false},{"id":1454653,"is_directory":false,"address":"25 Rue La Bo\u00e9tie","city":"Paris","zipcode":"75008","link":"\/ophtalmologue\/paris\/jean-cocci-paris","cloudinary_public_id":"fpmpvl1otrjxwklofz52","profile_id":57312,"exact_match":null,"priority_speciality":false,"first_name":"Jean","last_name":"COCCI","name_with_title":"Dr Jean COCCI","speciality":{"id":4,"name":"Ophtalmologue","slug":"ophtalmologue","search_results_priority":false,"telehealth_core":false,"vaccination":false,"covid_vaccination_hcp_speciality":false},"organization_status":null,"position":{"lat":48.8737525,"lng":2.31608440000002},"place_id":null,"telehealth":false}],"directory_doctors":[],"search_filters_context":[{"label":"Disponibilit\u00e9s","param_name":"availabilities","items":[{"name":"Aujourd'hui","id":1},{"name":"Dans les trois prochains jours","id":3}],"value":null},{"label":"Honoraires","param_name":"regulation_sector","items":[{"name":"Sans d\u00e9passements d'honoraires","id":"without_extra"},{"name":"D\u00e9passements d'honoraires mod\u00e9r\u00e9s","id":"with_extra"}],"value":null},{"label":"Motif de consultation","param_name":"ref_visit_motive_id","items":[{"name":"Premi\u00e8re consultation d'ophtalmologie","id":268},{"name":"Consultation d'ophtalmologie","id":716},{"name":"Urgence","id":166},{"name":"Bilan de la vue","id":271}],"value":null},{"label":"Langues parl\u00e9es","param_name":"language","items":[{"name":"Allemand","id":5},{"name":"Anglais","id":2},{"name":"Arabe","id":9},{"name":"Espagnol","id":3},{"name":"Italien","id":4},{"name":"Langue des signes","id":74},{"name":"Polonais","id":15},{"name":"Portugais","id":6},{"name":"Roumain","id":14},{"name":"Russe","id":16},{"name":"Turc","id":29}],"value":null}],"place":{"id":566509,"name":"Boulevard Haussmann","slug":"paris-boulevard-haussmann-9ccb02fd-270c-41a7-84f2-426ec71d305f","place_id":"Eig3NTAxMSBCb3VsZXZhcmQgSGF1c3NtYW5uLCBQYXJpcywgRnJhbmNlIi4qLAoUChIJeY1zJctv5kcRmQRo7bqo_9wSFAoSCQ-34gYfbuZHEWCUjGjDggsE","position":{"lat":48.87397,"lng":2.32312}},"telehealth_new_patient":false,"directory_title":"D'autres ophtalmologues consultent autour de vous","doctor_title":"Trouvez autour de vous un ophtalmologue (ou un professionnel pratiquant des actes de ophtalmologie) proposant la prise de rendez-vous en ligne","secondary_doctor_title":"D'autres ophtalmologues (ou professionnels pratiquant des actes de ophtalmologie) proposent la prise de rendez-vous en ligne dans les environs de Boulevard Haussmann","prior_nearby_location_title":"D'autres ophtalmologues proposent la prise de rendez-vous en ligne dans les environs de Boulevard Haussmann","non_prior_at_location_title":"D'autres professionnels pratiquant des actes de ophtalmologie proposent la prise de rendez-vous en ligne autour de vous","non_prior_nearby_location_title":"D'autres professionnels pratiquant des actes de ophtalmologie proposent la prise de rendez-vous en ligne dans les environs de Boulevard Haussmann","has_more":true,"search_scope":"speciality","is_hub":false,"total_search_results":999}}
JSON;

        $payload = json_decode($jsonData, true, 512, \JSON_OBJECT_AS_ARRAY);
        $expected = json_decode($jsonExpected, true, 512, \JSON_OBJECT_AS_ARRAY);
        $denormalized = SearchProfilesDataDenormalizer::denormalize($payload);

        $this->assertEquals($expected, $denormalized);
    }

    public function testDenormalizeNoKeyData(): void
    {
        $jsonData = <<<'JSON'
{"foo": "bar"}
JSON;

        $jsonExpected = <<<'JSON'
{"foo": "bar"}
JSON;

        $payload = json_decode($jsonData, true, 512, \JSON_OBJECT_AS_ARRAY);
        $expected = json_decode($jsonExpected, true, 512, \JSON_OBJECT_AS_ARRAY);
        $denormalized = SearchProfilesDataDenormalizer::denormalize($payload);

        $this->assertEquals($expected, $denormalized);
    }

    public function testDenormalizeNoKeyDoctors(): void
    {
        $jsonData = <<<'JSON'
{"data":{"foo": "bar"}}
JSON;

        $jsonExpected = <<<'JSON'
{"data":{"foo": "bar"}}
JSON;

        $payload = json_decode($jsonData, true, 512, \JSON_OBJECT_AS_ARRAY);
        $expected = json_decode($jsonExpected, true, 512, \JSON_OBJECT_AS_ARRAY);
        $denormalized = SearchProfilesDataDenormalizer::denormalize($payload);

        $this->assertEquals($expected, $denormalized);
    }
}
