<?php

declare(strict_types=1);

namespace Doctolib\Test\DataDenormalizer;

use Doctolib\DataDenormalizer\BookingDataDenormalizer;
use PHPUnit\Framework\TestCase;

/**
 * @covers \Doctolib\DataDenormalizer\BookingDataDenormalizer
 *
 * @internal
 */
class BookingDenormalizerTest extends TestCase
{
    public function testDenormalize(): void
    {
        $jsonData = <<<'JSON'
{"data":{"profile":{"id":90648,"name_with_title_and_determiner":"le Dr Anne Ruch","name_with_title":"Dr Anne MARTIN","speciality":{"id":1,"name":"Chirurgien-dentiste","created_at":"2013-10-17T13:48:20.309+02:00","updated_at":"2021-05-18T10:34:42.911+02:00","position":1,"title_allowed":true,"alternate_name":"Chirurgie dentaire","short_name":null,"name_en":"Dentist","alternate_name_en":null,"allow_multiple_booking":false,"deleted_at":null,"short_name_en":null,"ref_motive_search_enabled":true,"labels":{"plural":"Chirurgiens-dentistes","singular":"Chirurgien-dentiste","en_singular":null,"singular_female":null},"seo_top":true,"country":"fr","slug":"dentiste","regulation_sectors_search_enabled":false,"kind":"medical","self_onboarding":false,"searchable_by":"mapping","salesforce_id":"Chirurgien-dentiste","hidden":false,"practitioner_identity_verification_required":true,"prospect_name":"Chirurgien-dentiste","salesforce_slug":"CHIRURGIEN_DENTISTE_FR","data_sub_group":"dentists","pro_sante_connect_eligibility":true,"instant_messaging_searchability":true,"recall_friendly":false,"covid_vaccination_eligible":false,"medical_identifier_check_enabled":true,"availabilities_first_in_search":false},"organization":false,"redirect_url":"/dentiste/le-plessis-trevise","language_list":"Anglais et Français"},"specialities":[{"id":1,"name":"Chirurgien-dentiste","kind":"medical"}],"visit_motive_categories":[],"visit_motives":[{"id":496053,"name":"Consultation dentaire","visit_motive_category_id":null,"organization_id":23739,"speciality_id":1,"ref_visit_motive_id":157,"position":2,"telehealth":false,"vaccination_days_range":0,"vaccination_motive":false,"covid_vaccination_set_appointment_organization":false,"first_shot_motive":false,"allow_new_patients":true,"allow_new_patients_on_insurance_sector":null,"configurations":null},{"id":496057,"name":"Blanchiment des dents","visit_motive_category_id":null,"organization_id":23739,"speciality_id":1,"ref_visit_motive_id":161,"position":6,"telehealth":false,"vaccination_days_range":0,"vaccination_motive":false,"covid_vaccination_set_appointment_organization":false,"first_shot_motive":false,"allow_new_patients":true,"allow_new_patients_on_insurance_sector":null,"configurations":null},{"id":496487,"name":"Consultation d'esthétique dentaire","visit_motive_category_id":null,"organization_id":23739,"speciality_id":1,"ref_visit_motive_id":2961,"position":4,"telehealth":false,"vaccination_days_range":0,"vaccination_motive":false,"covid_vaccination_set_appointment_organization":false,"first_shot_motive":false,"allow_new_patients":true,"allow_new_patients_on_insurance_sector":null,"configurations":null},{"id":1622403,"name":"Première consultation dentaire","visit_motive_category_id":null,"organization_id":87291,"speciality_id":1,"ref_visit_motive_id":475,"position":2,"telehealth":false,"vaccination_days_range":0,"vaccination_motive":false,"covid_vaccination_set_appointment_organization":false,"first_shot_motive":false,"allow_new_patients":true,"allow_new_patients_on_insurance_sector":null,"configurations":null},{"id":1622410,"name":"Contrôle annuel et/ou détartrage","visit_motive_category_id":null,"organization_id":87291,"speciality_id":1,"ref_visit_motive_id":2964,"position":4,"telehealth":false,"vaccination_days_range":0,"vaccination_motive":false,"covid_vaccination_set_appointment_organization":false,"first_shot_motive":false,"allow_new_patients":true,"allow_new_patients_on_insurance_sector":null,"configurations":null},{"id":1622414,"name":"Consultation dentaire","visit_motive_category_id":null,"organization_id":87291,"speciality_id":1,"ref_visit_motive_id":157,"position":1,"telehealth":false,"vaccination_days_range":0,"vaccination_motive":false,"covid_vaccination_set_appointment_organization":false,"first_shot_motive":false,"allow_new_patients":true,"allow_new_patients_on_insurance_sector":null,"configurations":null},{"id":1622416,"name":"Consultation d'implantologie","visit_motive_category_id":null,"organization_id":87291,"speciality_id":1,"ref_visit_motive_id":1346,"position":3,"telehealth":false,"vaccination_days_range":0,"vaccination_motive":false,"covid_vaccination_set_appointment_organization":false,"first_shot_motive":false,"allow_new_patients":true,"allow_new_patients_on_insurance_sector":null,"configurations":null}],"agendas":[{"id":449621,"booking_disabled":false,"booking_temporary_disabled":false,"landline_number":"01 40 70 95 64","anonymous":false,"organization_id":23739,"visit_motive_ids_by_practice_id":{"30366":[496053,496487,496057]},"visit_motive_ids":[496053,496487,496057],"visit_motive_ids_only_for_doctors":null,"practice_id":30366,"speciality_id":1,"practitioner_id":778865,"insurance_sector_enabled":false,"equipment_agendas_required":false},{"id":46640,"booking_disabled":true,"booking_temporary_disabled":false,"landline_number":"01 85 64 44 55","anonymous":false,"organization_id":15468,"visit_motive_ids_by_practice_id":{},"visit_motive_ids":[],"visit_motive_ids_only_for_doctors":null,"practice_id":25386,"speciality_id":1,"practitioner_id":778865,"insurance_sector_enabled":false,"equipment_agendas_required":false},{"id":270800,"booking_disabled":false,"booking_temporary_disabled":false,"landline_number":"01 45 76 36 77","anonymous":false,"organization_id":87291,"visit_motive_ids_by_practice_id":{"107232":[1622414,1622403,1622416,1622410]},"visit_motive_ids":[1622414,1622403,1622416,1622410],"visit_motive_ids_only_for_doctors":null,"practice_id":107232,"speciality_id":1,"practitioner_id":778865,"insurance_sector_enabled":false,"equipment_agendas_required":false}],"places":[{"id":"practice-107232","address":"17 Avenue Ardouin","zipcode":"94420","city":"Le Plessis-Trévise","floor":1,"latitude":48.8087895,"longitude":2.57434560000002,"elevator":false,"handicap":false,"formal_name":"Cabinet dentaire des docteurs Swinburne et Ruch ","landline_number":"01 45 76 36 77","reception_info":null,"full_address":"17 Avenue Ardouin, 94420 Le Plessis-Trévise","opening_hours":[{"day":1,"ranges":[["09:00","19:00"]],"enabled":true},{"day":2,"ranges":[["09:00","19:00"]],"enabled":true},{"day":3,"ranges":[["09:00","20:00"]],"enabled":false},{"day":4,"ranges":[["09:00","19:00"]],"enabled":true},{"day":5,"ranges":[["09:00","19:00"]],"enabled":true},{"day":6,"ranges":[["09:00","12:30"]],"enabled":false},{"day":0,"ranges":[["09:00","13:00"]],"enabled":false}],"name":"Cabinet dentaire des docteurs Swinburne et Ruch ","practice_ids":[107232],"is_aphp":false,"aphp_url":"http://www.aphp.fr/contenu/combien-ca-coute","payment_means":"Chèques, espèces et cartes bancaires","regulation_sector":"Conventionné","insurance_card":true},{"id":"practice-30366","address":"8 Boulevard de la Madeleine","zipcode":"75009","city":"Paris","floor":0,"latitude":48.8700525,"longitude":2.3268962,"elevator":true,"handicap":true,"formal_name":"The Smile Clinic ","landline_number":"01 40 70 95 64","reception_info":null,"full_address":"8 Boulevard de la Madeleine, 75009 Paris","opening_hours":[{"day":1,"ranges":[["09:00","19:30"]],"enabled":true},{"day":2,"ranges":[["09:00","19:30"]],"enabled":true},{"day":3,"ranges":[["09:00","19:30"]],"enabled":true},{"day":4,"ranges":[["09:00","19:30"]],"enabled":true},{"day":5,"ranges":[["09:00","19:30"]],"enabled":true},{"day":6,"ranges":[["11:00","17:30"]],"enabled":true},{"day":0,"ranges":[["12:00","17:30"]],"enabled":false}],"name":"The Smile Clinic ","practice_ids":[30366],"is_aphp":false,"aphp_url":"http://www.aphp.fr/contenu/combien-ca-coute","payment_means":null,"regulation_sector":null,"insurance_card":null}],"practitioners":[{"id":778865,"profile_id":90648,"cloudinary_public_id":"dwwb56he5aiqow0unypp","name":"MARTIN","name_with_title_and_determiner":"le Dr Anne Ruch","name_with_title":"Dr Anne MARTIN","speciality":"Chirurgien-dentiste"}],"availabilities_preview_compatible":false,"vaccination_center":false,"number_future_vaccinations":0,"has_new_patient_rule":true}}
JSON;

        $jsonExpected = <<<'JSON'
{"data":{"profile":{"id":90648,"name_with_title_and_determiner":"le Dr Anne Ruch","name_with_title":"Dr Anne MARTIN","speciality":{"id":1,"name":"Chirurgien-dentiste","created_at":"2013-10-17T13:48:20.309+02:00","updated_at":"2021-05-18T10:34:42.911+02:00","position":1,"title_allowed":true,"alternate_name":"Chirurgie dentaire","short_name":null,"name_en":"Dentist","alternate_name_en":null,"allow_multiple_booking":false,"deleted_at":null,"short_name_en":null,"ref_motive_search_enabled":true,"labels":{"plural":"Chirurgiens-dentistes","singular":"Chirurgien-dentiste","en_singular":null,"singular_female":null},"seo_top":true,"country":"fr","slug":"dentiste","regulation_sectors_search_enabled":false,"kind":"medical","self_onboarding":false,"searchable_by":"mapping","salesforce_id":"Chirurgien-dentiste","hidden":false,"practitioner_identity_verification_required":true,"prospect_name":"Chirurgien-dentiste","salesforce_slug":"CHIRURGIEN_DENTISTE_FR","data_sub_group":"dentists","pro_sante_connect_eligibility":true,"instant_messaging_searchability":true,"recall_friendly":false,"covid_vaccination_eligible":false,"medical_identifier_check_enabled":true,"availabilities_first_in_search":false},"organization":false,"redirect_url":"\/dentiste\/le-plessis-trevise","language_list":"Anglais et Fran\u00e7ais"},"visit_motive_categories":[],"agendas":[{"id":449621,"booking_disabled":false,"booking_temporary_disabled":false,"landline_number":"01 40 70 95 64","anonymous":false,"organization_id":23739,"visit_motive_ids_only_for_doctors":null,"practice_id":30366,"speciality_id":1,"practitioner_id":778865,"insurance_sector_enabled":false,"equipment_agendas_required":false,"visit_motives":[{"id":496053,"name":"Consultation dentaire","visit_motive_category_id":null,"organization_id":23739,"ref_visit_motive_id":157,"position":2,"telehealth":false,"vaccination_days_range":0,"vaccination_motive":false,"covid_vaccination_set_appointment_organization":false,"first_shot_motive":false,"allow_new_patients":true,"allow_new_patients_on_insurance_sector":null,"configurations":null,"speciality":{"id":1,"name":"Chirurgien-dentiste","kind":"medical"}},{"id":496487,"name":"Consultation d'esth\u00e9tique dentaire","visit_motive_category_id":null,"organization_id":23739,"ref_visit_motive_id":2961,"position":4,"telehealth":false,"vaccination_days_range":0,"vaccination_motive":false,"covid_vaccination_set_appointment_organization":false,"first_shot_motive":false,"allow_new_patients":true,"allow_new_patients_on_insurance_sector":null,"configurations":null,"speciality":{"id":1,"name":"Chirurgien-dentiste","kind":"medical"}},{"id":496057,"name":"Blanchiment des dents","visit_motive_category_id":null,"organization_id":23739,"ref_visit_motive_id":161,"position":6,"telehealth":false,"vaccination_days_range":0,"vaccination_motive":false,"covid_vaccination_set_appointment_organization":false,"first_shot_motive":false,"allow_new_patients":true,"allow_new_patients_on_insurance_sector":null,"configurations":null,"speciality":{"id":1,"name":"Chirurgien-dentiste","kind":"medical"}}],"visit_motive_by_practice_id":{"30366":[{"id":496053,"name":"Consultation dentaire","visit_motive_category_id":null,"organization_id":23739,"ref_visit_motive_id":157,"position":2,"telehealth":false,"vaccination_days_range":0,"vaccination_motive":false,"covid_vaccination_set_appointment_organization":false,"first_shot_motive":false,"allow_new_patients":true,"allow_new_patients_on_insurance_sector":null,"configurations":null,"speciality":{"id":1,"name":"Chirurgien-dentiste","kind":"medical"}},{"id":496487,"name":"Consultation d'esth\u00e9tique dentaire","visit_motive_category_id":null,"organization_id":23739,"ref_visit_motive_id":2961,"position":4,"telehealth":false,"vaccination_days_range":0,"vaccination_motive":false,"covid_vaccination_set_appointment_organization":false,"first_shot_motive":false,"allow_new_patients":true,"allow_new_patients_on_insurance_sector":null,"configurations":null,"speciality":{"id":1,"name":"Chirurgien-dentiste","kind":"medical"}},{"id":496057,"name":"Blanchiment des dents","visit_motive_category_id":null,"organization_id":23739,"ref_visit_motive_id":161,"position":6,"telehealth":false,"vaccination_days_range":0,"vaccination_motive":false,"covid_vaccination_set_appointment_organization":false,"first_shot_motive":false,"allow_new_patients":true,"allow_new_patients_on_insurance_sector":null,"configurations":null,"speciality":{"id":1,"name":"Chirurgien-dentiste","kind":"medical"}}]}},{"id":46640,"booking_disabled":true,"booking_temporary_disabled":false,"landline_number":"01 85 64 44 55","anonymous":false,"organization_id":15468,"visit_motive_ids_only_for_doctors":null,"practice_id":25386,"speciality_id":1,"practitioner_id":778865,"insurance_sector_enabled":false,"equipment_agendas_required":false,"visit_motives":[]},{"id":270800,"booking_disabled":false,"booking_temporary_disabled":false,"landline_number":"01 45 76 36 77","anonymous":false,"organization_id":87291,"visit_motive_ids_only_for_doctors":null,"practice_id":107232,"speciality_id":1,"practitioner_id":778865,"insurance_sector_enabled":false,"equipment_agendas_required":false,"visit_motives":[{"id":1622414,"name":"Consultation dentaire","visit_motive_category_id":null,"organization_id":87291,"ref_visit_motive_id":157,"position":1,"telehealth":false,"vaccination_days_range":0,"vaccination_motive":false,"covid_vaccination_set_appointment_organization":false,"first_shot_motive":false,"allow_new_patients":true,"allow_new_patients_on_insurance_sector":null,"configurations":null,"speciality":{"id":1,"name":"Chirurgien-dentiste","kind":"medical"}},{"id":1622403,"name":"Premi\u00e8re consultation dentaire","visit_motive_category_id":null,"organization_id":87291,"ref_visit_motive_id":475,"position":2,"telehealth":false,"vaccination_days_range":0,"vaccination_motive":false,"covid_vaccination_set_appointment_organization":false,"first_shot_motive":false,"allow_new_patients":true,"allow_new_patients_on_insurance_sector":null,"configurations":null,"speciality":{"id":1,"name":"Chirurgien-dentiste","kind":"medical"}},{"id":1622416,"name":"Consultation d'implantologie","visit_motive_category_id":null,"organization_id":87291,"ref_visit_motive_id":1346,"position":3,"telehealth":false,"vaccination_days_range":0,"vaccination_motive":false,"covid_vaccination_set_appointment_organization":false,"first_shot_motive":false,"allow_new_patients":true,"allow_new_patients_on_insurance_sector":null,"configurations":null,"speciality":{"id":1,"name":"Chirurgien-dentiste","kind":"medical"}},{"id":1622410,"name":"Contr\u00f4le annuel et\/ou d\u00e9tartrage","visit_motive_category_id":null,"organization_id":87291,"ref_visit_motive_id":2964,"position":4,"telehealth":false,"vaccination_days_range":0,"vaccination_motive":false,"covid_vaccination_set_appointment_organization":false,"first_shot_motive":false,"allow_new_patients":true,"allow_new_patients_on_insurance_sector":null,"configurations":null,"speciality":{"id":1,"name":"Chirurgien-dentiste","kind":"medical"}}],"visit_motive_by_practice_id":{"107232":[{"id":1622414,"name":"Consultation dentaire","visit_motive_category_id":null,"organization_id":87291,"ref_visit_motive_id":157,"position":1,"telehealth":false,"vaccination_days_range":0,"vaccination_motive":false,"covid_vaccination_set_appointment_organization":false,"first_shot_motive":false,"allow_new_patients":true,"allow_new_patients_on_insurance_sector":null,"configurations":null,"speciality":{"id":1,"name":"Chirurgien-dentiste","kind":"medical"}},{"id":1622403,"name":"Premi\u00e8re consultation dentaire","visit_motive_category_id":null,"organization_id":87291,"ref_visit_motive_id":475,"position":2,"telehealth":false,"vaccination_days_range":0,"vaccination_motive":false,"covid_vaccination_set_appointment_organization":false,"first_shot_motive":false,"allow_new_patients":true,"allow_new_patients_on_insurance_sector":null,"configurations":null,"speciality":{"id":1,"name":"Chirurgien-dentiste","kind":"medical"}},{"id":1622416,"name":"Consultation d'implantologie","visit_motive_category_id":null,"organization_id":87291,"ref_visit_motive_id":1346,"position":3,"telehealth":false,"vaccination_days_range":0,"vaccination_motive":false,"covid_vaccination_set_appointment_organization":false,"first_shot_motive":false,"allow_new_patients":true,"allow_new_patients_on_insurance_sector":null,"configurations":null,"speciality":{"id":1,"name":"Chirurgien-dentiste","kind":"medical"}},{"id":1622410,"name":"Contr\u00f4le annuel et\/ou d\u00e9tartrage","visit_motive_category_id":null,"organization_id":87291,"ref_visit_motive_id":2964,"position":4,"telehealth":false,"vaccination_days_range":0,"vaccination_motive":false,"covid_vaccination_set_appointment_organization":false,"first_shot_motive":false,"allow_new_patients":true,"allow_new_patients_on_insurance_sector":null,"configurations":null,"speciality":{"id":1,"name":"Chirurgien-dentiste","kind":"medical"}}]}}],"places":[{"id":"practice-107232","address":"17 Avenue Ardouin","zipcode":"94420","city":"Le Plessis-Tr\u00e9vise","floor":1,"latitude":48.8087895,"longitude":2.57434560000002,"elevator":false,"handicap":false,"formal_name":"Cabinet dentaire des docteurs Swinburne et Ruch ","landline_number":"01 45 76 36 77","reception_info":null,"full_address":"17 Avenue Ardouin, 94420 Le Plessis-Tr\u00e9vise","opening_hours":[{"day":1,"ranges":[["09:00","19:00"]],"enabled":true},{"day":2,"ranges":[["09:00","19:00"]],"enabled":true},{"day":3,"ranges":[["09:00","20:00"]],"enabled":false},{"day":4,"ranges":[["09:00","19:00"]],"enabled":true},{"day":5,"ranges":[["09:00","19:00"]],"enabled":true},{"day":6,"ranges":[["09:00","12:30"]],"enabled":false},{"day":0,"ranges":[["09:00","13:00"]],"enabled":false}],"name":"Cabinet dentaire des docteurs Swinburne et Ruch ","practice_ids":[107232],"is_aphp":false,"aphp_url":"http:\/\/www.aphp.fr\/contenu\/combien-ca-coute","payment_means":"Ch\u00e8ques, esp\u00e8ces et cartes bancaires","regulation_sector":"Conventionn\u00e9","insurance_card":true},{"id":"practice-30366","address":"8 Boulevard de la Madeleine","zipcode":"75009","city":"Paris","floor":0,"latitude":48.8700525,"longitude":2.3268962,"elevator":true,"handicap":true,"formal_name":"The Smile Clinic ","landline_number":"01 40 70 95 64","reception_info":null,"full_address":"8 Boulevard de la Madeleine, 75009 Paris","opening_hours":[{"day":1,"ranges":[["09:00","19:30"]],"enabled":true},{"day":2,"ranges":[["09:00","19:30"]],"enabled":true},{"day":3,"ranges":[["09:00","19:30"]],"enabled":true},{"day":4,"ranges":[["09:00","19:30"]],"enabled":true},{"day":5,"ranges":[["09:00","19:30"]],"enabled":true},{"day":6,"ranges":[["11:00","17:30"]],"enabled":true},{"day":0,"ranges":[["12:00","17:30"]],"enabled":false}],"name":"The Smile Clinic ","practice_ids":[30366],"is_aphp":false,"aphp_url":"http:\/\/www.aphp.fr\/contenu\/combien-ca-coute","payment_means":null,"regulation_sector":null,"insurance_card":null}],"practitioners":[{"id":778865,"profile_id":90648,"cloudinary_public_id":"dwwb56he5aiqow0unypp","name":"MARTIN","name_with_title_and_determiner":"le Dr Anne Ruch","name_with_title":"Dr Anne MARTIN","speciality":"Chirurgien-dentiste"}],"availabilities_preview_compatible":false,"vaccination_center":false,"number_future_vaccinations":0,"has_new_patient_rule":true}}
JSON;

        $payload = json_decode($jsonData, true, 512, \JSON_OBJECT_AS_ARRAY);
        $expected = json_decode($jsonExpected, true, 512, \JSON_OBJECT_AS_ARRAY);
        $denormalized = BookingDataDenormalizer::denormalize($payload);

        $this->assertEquals($expected, $denormalized);
    }

    public function testDenormalizeNoKeyData(): void
    {
        $jsonData = <<<'JSON'
{"foo": "bar"}
JSON;

        $jsonExpected = <<<'JSON'
{"foo": "bar"}
JSON;

        $payload = json_decode($jsonData, true, 512, \JSON_OBJECT_AS_ARRAY);
        $expected = json_decode($jsonExpected, true, 512, \JSON_OBJECT_AS_ARRAY);
        $denormalized = BookingDataDenormalizer::denormalize($payload);

        $this->assertEquals($expected, $denormalized);
    }

    public function testDenormalizeNoKeyAgendas(): void
    {
        $jsonData = <<<'JSON'
{"data":{"foo": "bar"}}
JSON;

        $jsonExpected = <<<'JSON'
{"data":{"foo": "bar"}}
JSON;

        $payload = json_decode($jsonData, true, 512, \JSON_OBJECT_AS_ARRAY);
        $expected = json_decode($jsonExpected, true, 512, \JSON_OBJECT_AS_ARRAY);
        $denormalized = BookingDataDenormalizer::denormalize($payload);

        $this->assertEquals($expected, $denormalized);
    }
}
